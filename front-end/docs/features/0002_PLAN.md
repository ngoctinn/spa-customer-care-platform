# Kế hoạch Kỹ thuật: Refactor Luồng Xác thực với Refresh Token

## 1. Mô tả Ngữ cảnh

Kế hoạch này mô tả các thay đổi kỹ thuật cần thiết để nâng cấp hệ thống xác thực phía front-end, chuyển từ việc sử dụng một access token duy nhất sang cơ chế **Access Token (ngắn hạn)** và **Refresh Token (dài hạn)**. Mục tiêu là triển khai một luồng làm mới token tự động khi access token hết hạn, dựa trên tài liệu `AUTH_API_GUIDE.md v2.1`, nhằm cải thiện bảo mật và trải nghiệm người dùng.

## 2. Các Tệp và Hàm Liên quan

-   **TẠO MỚI:** `src/lib/tokenStore.ts`
    -   *Mục đích:* Tạo một store đơn giản trong bộ nhớ để lưu trữ và quản lý `access_token` một cách nhất quán giữa các module.

-   **CẬP NHẬT:** `src/lib/apiClient.ts`
    -   *Mục đích:* Tích hợp logic cốt lõi để tự động bắt lỗi `401 Unauthorized`, gọi API làm mới token, và thử lại request ban đầu.

-   **CẬP NHẬT:** `src/features/auth/apis/auth_api.ts`
    -   *Mục đích:* Điều chỉnh các hàm API cho phù hợp với endpoint và cấu trúc dữ liệu mới của v2.1.
    -   `login()`: Sửa endpoint, phương thức và payload.
    -   `fetchProfile()`: Đổi tên endpoint thành `/auth/me`.
    -   Tạo hàm mới `refreshToken()` để gọi `POST /auth/refresh`.

-   **CẬP NHẬT:** `src/features/auth/contexts/AuthContexts.tsx`
    -   *Mục đích:* Điều chỉnh `AuthContext` để tương tác với `tokenStore` thay vì quản lý token trực tiếp.

-   **CẬP NHẬT (Cần Rà Soát):** `src/middleware.ts`
    -   *Mục đích:* Logic của middleware hiện đang dựa vào `access_token` trong cookie, cần được xem xét lại để hoạt động với `refresh_token` trong `HttpOnly` cookie.

## 3. Thuật toán/Logic (Từng bước)

### Luồng Tự động Làm mới Access Token trong `apiClient`

Đây là luồng xử lý chính khi một API call sử dụng `access_token` đã hết hạn.

1.  **Gửi Request Ban Đầu:**
    -   `apiClient` được gọi để thực hiện một request (ví dụ: `GET /some/protected/data`).
    -   Trước khi gửi, nó lấy `access_token` từ `tokenStore.getToken()`.
    -   Nếu có token, nó sẽ được thêm vào header: `Authorization: Bearer <token>`.

2.  **Kiểm tra Response:**
    -   Request được gửi đi.
    -   `apiClient` kiểm tra `response.status`.

3.  **Xử lý Lỗi 401 Unauthorized:**
    -   Nếu `response.status` là `401`, `apiClient` sẽ **không** ném lỗi ngay. Thay vào đó, nó sẽ kích hoạt luồng làm mới token.

4.  **Gọi API Làm mới Token:**
    -   `apiClient` gọi hàm `refreshToken()` (từ `auth_api.ts`). Hàm này sẽ thực hiện `POST /auth/refresh`.

5.  **Xử lý Kết quả Refresh:**
    -   **Trường hợp 1: Refresh Thành Công**
        -   API `/auth/refresh` trả về một `access_token` mới.
        -   `apiClient` gọi `tokenStore.setToken()` để lưu trữ token mới này.
        -   `apiClient` **tự động thực hiện lại (retry)** request ban đầu (ví dụ: `GET /some/protected/data`) với `access_token` mới trong header.
        -   Kết quả của request được retry này sẽ được trả về cho hàm gọi `apiClient` ban đầu. Luồng này hoàn toàn trong suốt đối với component/hook gọi API.
    -   **Trường hợp 2: Refresh Thất Bại**
        -   API `/auth/refresh` cũng trả về lỗi `401` (nghĩa là `refresh_token` đã hết hạn hoặc không hợp lệ).
        -   `apiClient` xác định rằng phiên đăng nhập đã thực sự kết thúc.
        -   Nó sẽ gọi `tokenStore.clearToken()` để dọn dẹp.
        -   Thực hiện đăng xuất người dùng (ví dụ: điều hướng đến trang `/auth/login`).
        -   Ném ra `ApiError` cuối cùng để dừng mọi tiến trình.

## 4. Cấu trúc Dữ liệu & State

-   **TẠO MỚI:** `src/lib/tokenStore.ts`
    -   Sẽ export một object chứa các hàm để quản lý một biến `accessToken` cục bộ trong module.
    -   `let accessToken: string | null = null;`
    -   `setToken(token: string): void`
    -   `getToken(): string | null`
    -   `clearToken(): void`

-   **CẬP NHẬT:** `src/features/auth/contexts/AuthContexts.tsx`
    -   `login` function: Sau khi gọi `apiLogin` thành công, sẽ nhận `access_token` và gọi `tokenStore.setToken(token)`.
    -   `logout` function: Sẽ gọi `tokenStore.clearToken()` như một phần của quá trình đăng xuất.

-   **CẬP NHẬT:** `src/features/auth/apis/auth_api.ts`
    -   Hàm `login` sẽ xử lý response có dạng: `{ "access_token": string, "token_type": "bearer" }`.
    -   Hàm `fetchProfile` sẽ xử lý response từ `/auth/me` với cấu trúc mới (chứa mảng `roles`).
