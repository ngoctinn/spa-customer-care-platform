# Kế Hoạch Kỹ Thuật: Quản Lý Khuyến Mãi (Promotions)

## 1. Mô tả Ngữ cảnh

Xây dựng một trang quản lý toàn diện cho phép Quản trị viên (Admin) thực hiện các thao tác CRUD (Tạo, Đọc, Cập nhật, Xóa) đối với các mã giảm giá/khuyến mãi (Promotions). Tính năng này sẽ tái sử dụng kiến trúc quản lý tài nguyên sẵn có của dự án.

## 2. Các Tệp và Hàm Liên quan

### Tệp Mới

*   **Page Route:**
    *   `TẠO MỚI`: `src/app/(admin)/dashboard/promotions/page.tsx` - Trang chính để hiển thị giao diện quản lý khuyến mãi.
*   **Feature Logic & Components (`src/features/promotion/`):**
    *   `TẠO MỚI`: `src/features/promotion/types/index.ts` - Định nghĩa kiểu dữ liệu `Promotion`.
    *   `TẠO MỚI`: `src/features/promotion/schemas/index.ts` - Định nghĩa Zod schema để xác thực dữ liệu form.
    *   `TẠO MỚI`: `src/features/promotion/api/index.ts` - Các hàm gọi API để thực hiện CRUD.
    *   `TẠO MỚI`: `src/features/promotion/hooks/usePromotionManagement.ts` - Hook chính điều phối logic, sử dụng lại `useResourceManagement`.
    *   `TẠO MỚI`: `src/features/promotion/components/PromotionForm.tsx` - Form để thêm/sửa khuyến mãi.
    *   `TẠO MỚI`: `src/features/promotion/components/PromotionsDataTable.tsx` - Bảng hiển thị danh sách khuyến mãi với các cột tương ứng.

### Tệp Cần Cập Nhật

*   **Layout/Navigation:**
    *   `CẬP NHẬT`: `src/data/constants.ts` (hoặc file chứa cấu hình sidebar) - Thêm mục "Khuyến Mãi" vào danh sách điều hướng của admin.

## 3. Thuật toán/Logic (Từng bước)

### Luồng Tương Tác Người Dùng

1.  **Truy cập:** Admin nhấn vào mục "Khuyến Mãi" trên thanh sidebar.
2.  **Hiển thị Dữ liệu:**
    *   Ứng dụng điều hướng đến `/dashboard/promotions`.
    *   `PromotionsPage` được render, sử dụng `ResourcePageLayout`.
    *   `usePromotionManagement` được gọi, hook này sẽ khởi tạo `useResourceManagement` với các hàm API và key của "promotion".
    *   Dữ liệu khuyến mãi được fetch từ server và hiển thị trong component `PromotionsDataTable`.
3.  **Thêm Mới:**
    *   Admin nhấn nút "Thêm Khuyến Mãi".
    *   `FormDialog` hiện ra, chứa component `PromotionForm`.
    *   Admin nhập thông tin (tên, phần trăm, khoảng thời gian, v.v.) và nhấn "Lưu".
    *   Dữ liệu được xác thực bằng `PromotionSchema`.
    *   Nếu hợp lệ, hàm `createPromotion` được gọi. React Query sẽ tự động cập nhật lại danh sách.
4.  **Cập Nhật:**
    *   Admin chọn "Sửa" từ menu của một dòng trong bảng.
    *   `FormDialog` hiện ra, `PromotionForm` được điền sẵn dữ liệu của khuyến mãi đó.
    *   Admin chỉnh sửa thông tin và nhấn "Lưu".
    *   Hàm `updatePromotion` được gọi. React Query cập nhật lại dòng tương ứng.
5.  **Xóa:**
    *   Admin chọn "Xóa" từ menu.
    *   `ConfirmationModal` hiện ra để xác nhận.
    *   Admin xác nhận, hàm `deletePromotion` được gọi. React Query xóa khuyến mãi khỏi danh sách.

## 4. Cấu trúc Dữ liệu & State

### `src/features/promotion/types/index.ts`

```typescript
/**
 * @interface Promotion
 * @description Đại diện cho một mã khuyến mãi trong hệ thống.
 * @property {string} id - Mã định danh duy nhất.
 * @property {string} name - Tên của chương trình khuyến mãi.
 * @property {string} [description] - Mô tả chi tiết.
 * @property {number} discount_percentage - Phần trăm giảm giá (từ 0 đến 100).
 * @property {string} start_date - Ngày bắt đầu hiệu lực (chuỗi ISO 8601).
 * @property {string} end_date - Ngày kết thúc hiệu lực (chuỗi ISO 8601).
 * @property {string} created_at - Ngày tạo.
 */
export interface Promotion {
  id: string;
  name: string;
  description?: string;
  discount_percentage: number;
  start_date: string;
  end_date: string;
  created_at: string;
}
```

### `src/features/promotion/schemas/index.ts`

```typescript
import * as z from 'zod';

/**
 * @const PromotionSchema
 * @description Schema để xác thực dữ liệu form thêm/sửa khuyến mãi.
 * Sử dụng date_range để làm việc với component DatePicker và refine để đảm bảo ngày kết thúc hợp lệ.
 */
export const PromotionSchema = z.object({
  name: z.string().min(1, "Tên khuyến mãi là bắt buộc"),
  description: z.string().optional(),
  discount_percentage: z.coerce
    .number({ invalid_type_error: "Phần trăm giảm giá phải là một con số" })
    .min(0, "Không được nhỏ hơn 0%")
    .max(100, "Không được lớn hơn 100%"),
  date_range: z.object({
    from: z.date({ required_error: "Ngày bắt đầu là bắt buộc" }),
    to: z.date({ required_error: "Ngày kết thúc là bắt buộc" }),
  }),
})
.refine((data) => data.date_range.to >= data.date_range.from, {
  message: "Ngày kết thúc phải sau hoặc bằng ngày bắt đầu",
  path: ["date_range", "to"], // Chỉ rõ lỗi ở trường ngày kết thúc
});
```

### Quản lý State

*   **Server State:** Toàn bộ dữ liệu khuyến mãi sẽ được quản lý bởi **React Query** thông qua hook `useResourceManagement`.
*   **Client State:** Trạng thái của form (do `react-hook-form` quản lý) và trạng thái đóng/mở của dialog sẽ là state cục bộ, không cần dùng **Zustand**.
