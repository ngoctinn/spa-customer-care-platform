# üë• Customer Module - H∆∞·ªõng D·∫´n Chi Ti·∫øt

**Phi√™n b·∫£n:** 1.0 | **C·∫≠p nh·∫≠t:** Oct 17, 2025

---

## üìë M·ª•c L·ª•c

1. [T·ªïng Quan](#-t·ªïng-quan)
2. [Ki·∫øn Tr√∫c Module](#-ki·∫øn-tr√∫c-module)
3. [Data Model](#-data-model)
4. [API Endpoints](#-api-endpoints)
5. [Lu·ªìng Nghi·ªáp V·ª•](#-lu·ªìng-nghi·ªáp-v·ª•)
6. [V√≠ D·ª• S·ª≠ D·ª•ng](#-v√≠-d·ª•-s·ª≠-d·ª•ng)
7. [X·ª≠ L√Ω L·ªói](#-x·ª≠-l√Ω-l·ªói)
8. [Best Practices](#-best-practices)

---

## üìã T·ªïng Quan

### M·ª•c ƒê√≠ch

Module `customers` qu·∫£n l√Ω **h·ªì s∆° kh√°ch h√†ng (CRM)** ƒë·ªôc l·∫≠p v·ªõi t√†i kho·∫£n x√°c th·ª±c (Auth).

**ƒê·∫∑c ƒëi·ªÉm ch√≠nh:**

- ‚úÖ **Kh√°ch h√†ng v√£ng lai (Walk-in):** Kh√¥ng c·∫ßn t√†i kho·∫£n, ch·ªâ c·∫ßn t√™n + SƒêT
- ‚úÖ **Kh√°ch h√†ng online:** Li√™n k·∫øt v·ªõi t√†i kho·∫£n User (1-to-1)
- ‚úÖ **Qu·∫£n l√Ω h·ªì s∆°:** L∆∞u th√¥ng tin chi ti·∫øt (ng√†y sinh, gi·ªõi t√≠nh, lo·∫°i da, ghi ch√∫ y t·∫ø)
- ‚úÖ **X√≥a m·ªÅm (Soft Delete):** Kh√¥ng x√≥a vƒ©nh vi·ªÖn, c√≥ th·ªÉ kh√¥i ph·ª•c
- ‚úÖ **T√¨m ki·∫øm:** Theo t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i

### Quy ∆Ø·ªõc

| Kh√°i Ni·ªám            | ƒê·ªãnh Nghƒ©a                            | V√≠ D·ª•                                     |
| -------------------- | ------------------------------------- | ----------------------------------------- |
| **Walk-in Customer** | Kh√°ch h√†ng v√£ng lai, `user_id = NULL` | Kh√°ch ƒë·∫øn l·∫ßn ƒë·∫ßu kh√¥ng ƒëƒÉng k√Ω t√†i kho·∫£n |
| **Online Customer**  | C√≥ t√†i kho·∫£n, `user_id != NULL`       | Kh√°ch ƒëƒÉng k√Ω app, ƒë√£ ƒëƒÉng nh·∫≠p           |
| **Stub Customer**    | H·ªì s∆° "ch·ªù" khi user v·ª´a ƒëƒÉng k√Ω      | Full name & phone ch∆∞a ho√†n th√†nh         |
| **Soft Delete**      | ƒê·∫∑t `deleted_at`, kh√¥ng x√≥a th·ª±c s·ª±   | C√≥ th·ªÉ kh√¥i ph·ª•c sau                      |

---

## üèóÔ∏è Ki·∫øn Tr√∫c Module

### C·∫•u Tr√∫c Th∆∞ M·ª•c

```
src/modules/customers/
‚îú‚îÄ‚îÄ __init__.py              # Export c√¥ng khai
‚îú‚îÄ‚îÄ models.py                # SQLModel - Database schema
‚îú‚îÄ‚îÄ schemas.py               # Pydantic - Request/Response DTOs
‚îú‚îÄ‚îÄ router.py                # FastAPI routes
‚îú‚îÄ‚îÄ service.py               # Business logic
‚îú‚îÄ‚îÄ crud.py                  # Database operations (CRUD)
‚îî‚îÄ‚îÄ test_customers.py        # Unit tests (n·∫øu c√≥)
```

### Ki·∫øn Tr√∫c T·∫ßng

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FastAPI Router (router.py)             ‚îÇ  HTTP endpoints
‚îÇ  ‚îú‚îÄ POST /customers/walk-in             ‚îÇ  Create walk-in
‚îÇ  ‚îú‚îÄ POST /customers/profile             ‚îÇ  Complete profile
‚îÇ  ‚îú‚îÄ GET /customers/{id}                 ‚îÇ  Get customer
‚îÇ  ‚îú‚îÄ PUT /customers/{id}                 ‚îÇ  Update
‚îÇ  ‚îî‚îÄ DELETE /customers/{id}              ‚îÇ  Soft delete
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Service Layer (service.py)             ‚îÇ  Business logic
‚îÇ  ‚îú‚îÄ create_walk_in_customer()           ‚îÇ
‚îÇ  ‚îú‚îÄ complete_customer_profile()         ‚îÇ
‚îÇ  ‚îú‚îÄ verify_otp_and_link_account()       ‚îÇ
‚îÇ  ‚îú‚îÄ delete_customer()                   ‚îÇ
‚îÇ  ‚îî‚îÄ restore_customer()                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  CRUD Layer (crud.py)                   ‚îÇ  Database access
‚îÇ  ‚îú‚îÄ create_customer()                   ‚îÇ
‚îÇ  ‚îú‚îÄ get_customer_by_id()                ‚îÇ
‚îÇ  ‚îú‚îÄ update_customer()                   ‚îÇ
‚îÇ  ‚îî‚îÄ soft_delete_customer()              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Database (PostgreSQL)                  ‚îÇ  Persistent data
‚îÇ  ‚îî‚îÄ customer table                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üíæ Data Model

### Customer Table Schema

```sql
CREATE TABLE customer (
    id                 INTEGER PRIMARY KEY AUTO_INCREMENT,
    user_id            INTEGER UNIQUE NULL (FK -> user.id),
    full_name          VARCHAR(255) NULL,
    phone_number       VARCHAR(20) UNIQUE NULL,
    date_of_birth      DATE NULL,
    gender             VARCHAR(10) NULL,          -- 'nam', 'n·ªØ', 'kh√°c'
    address            TEXT NULL,
    notes              TEXT NULL,                 -- Ghi ch√∫ CSKH
    skin_type          VARCHAR(50) NULL,          -- 'kh√¥', 'd·∫ßu', 'h·ªón h·ª£p', 'nh·∫°y c·∫£m'
    health_conditions  TEXT NULL,                 -- D·ªã ·ª©ng, b·ªánh n·ªÅn
    is_active          BOOLEAN NOT NULL = True,
    created_at         TIMESTAMP NOT NULL,        -- UTC
    updated_at         TIMESTAMP NOT NULL,        -- UTC
    deleted_at         TIMESTAMP NULL             -- Soft delete
);

-- Indexes for performance
CREATE INDEX idx_customer_user_id ON customer(user_id);
CREATE INDEX idx_customer_phone_number ON customer(phone_number);
CREATE INDEX idx_customer_deleted_at ON customer(deleted_at);
```

### Pydantic Schemas

#### Request: Create Walk-in Customer

```python
class CustomerCreateRequest(BaseModel):
    full_name: str          # Min 1, Max 255
    phone_number: str       # Min 9, Max 20, auto-normalized
```

**Normalize** t·ª± ƒë·ªông:

- Lo·∫°i b·ªè kho·∫£ng tr·∫Øng, k√Ω t·ª± ƒë·∫∑c bi·ªát
- Duy tr√¨ m√£ qu·ªëc gia (n·∫øu c√≥): `+84...` ho·∫∑c `0...`

#### Request: Complete Profile

```python
class CustomerCompleteProfileRequest(BaseModel):
    full_name: str                      # Required
    phone_number: str                   # Required
    date_of_birth: Optional[date]       # Optional
    gender: Optional[str]               # Optional
    address: Optional[str]              # Optional
    notes: Optional[str]                # Optional
    skin_type: Optional[str]            # Optional
    health_conditions: Optional[str]    # Optional
```

#### Request: Update Customer

```python
class CustomerUpdateRequest(BaseModel):
    full_name: Optional[str]            # All fields optional
    phone_number: Optional[str]
    date_of_birth: Optional[date]
    gender: Optional[str]
    address: Optional[str]
    notes: Optional[str]
    skin_type: Optional[str]
    health_conditions: Optional[str]
    is_active: Optional[bool]
```

#### Response: Customer

```python
class CustomerResponse(BaseModel):
    id: int
    user_id: Optional[int]
    full_name: Optional[str]
    phone_number: Optional[str]
    date_of_birth: Optional[date]
    gender: Optional[str]
    address: Optional[str]
    notes: Optional[str]
    skin_type: Optional[str]
    health_conditions: Optional[str]
    is_active: bool
    created_at: datetime
    updated_at: datetime
    deleted_at: Optional[datetime]

    class Config:
        from_attributes = True  # SQLAlchemy -> Pydantic
```

---

## üîå API Endpoints

### 1Ô∏è‚É£ Create Walk-in Customer (Lu·ªìng 1)

**T·∫°o kh√°ch h√†ng v√£ng lai - kh√¥ng y√™u c·∫ßu t√†i kho·∫£n.**

```
POST /customers/walk-in
Content-Type: application/json

{
  "full_name": "Nguy·ªÖn VƒÉn A",
  "phone_number": "0901234567"
}
```

**Response (201 Created):**

```json
{
  "id": 1,
  "user_id": null,
  "full_name": "Nguy·ªÖn VƒÉn A",
  "phone_number": "0901234567",
  "date_of_birth": null,
  "gender": null,
  "address": null,
  "notes": null,
  "skin_type": null,
  "health_conditions": null,
  "is_active": true,
  "created_at": "2025-10-17T10:30:00Z",
  "updated_at": "2025-10-17T10:30:00Z",
  "deleted_at": null
}
```

**Errors:**

| Status            | Error                      | Nguy√™n Nh√¢n        |
| ----------------- | -------------------------- | ------------------ |
| `409 Conflict`    | `S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i` | Phone number tr√πng |
| `400 Bad Request` | Validation error           | Request format sai |

---

### 2Ô∏è‚É£ Complete Profile (Lu·ªìng 2b)

**Ho√†n th√†nh h·ªì s∆° khi user ƒë√£ ƒëƒÉng k√Ω - c·∫≠p nh·∫≠t full_name & phone_number cho stub customer.**

```
POST /customers/profile
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "full_name": "Nguy·ªÖn VƒÉn B",
  "phone_number": "0987654321",
  "date_of_birth": "1990-05-15",
  "gender": "nam",
  "address": "123 ƒê∆∞·ªùng A, TP HCM",
  "skin_type": "h·ªón h·ª£p",
  "health_conditions": "D·ªã ·ª©ng v·ªõi x√† ph√≤ng m·∫°nh"
}
```

**Response (200 OK):**

```json
{
  "id": 2,
  "user_id": 5,
  "full_name": "Nguy·ªÖn VƒÉn B",
  "phone_number": "0987654321",
  "date_of_birth": "1990-05-15",
  "gender": "nam",
  "address": "123 ƒê∆∞·ªùng A, TP HCM",
  "notes": null,
  "skin_type": "h·ªón h·ª£p",
  "health_conditions": "D·ªã ·ª©ng v·ªõi x√† ph√≤ng m·∫°nh",
  "is_active": true,
  "created_at": "2025-10-17T10:00:00Z",
  "updated_at": "2025-10-17T10:35:00Z",
  "deleted_at": null
}
```

**Requirements:**

- ‚úÖ JWT token b·∫Øt bu·ªôc (authenticated user)
- ‚úÖ User ch·ªâ c√≥ th·ªÉ c·∫≠p nh·∫≠t h·ªì s∆° c·ªßa ch√≠nh m√¨nh
- ‚úÖ Phone number ph·∫£i duy nh·∫•t

**Errors:**

| Status             | Error                    | Nguy√™n Nh√¢n                     |
| ------------------ | ------------------------ | ------------------------------- |
| `401 Unauthorized` | No token                 | Kh√¥ng g·ª≠i JWT                   |
| `404 Not Found`    | H·ªì s∆° kh√¥ng t√¨m th·∫•y     | User ch∆∞a c√≥ stub customer      |
| `409 Conflict`     | S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i | Phone tr√πng v·ªõi kh√°ch h√†ng kh√°c |

---

### 3Ô∏è‚É£ Get Customer

**L·∫•y th√¥ng tin kh√°ch h√†ng theo ID.**

```
GET /customers/{customer_id}

# Example
GET /customers/1
```

**Response (200 OK):**

```json
{
  "id": 1,
  "user_id": null,
  "full_name": "Nguy·ªÖn VƒÉn A",
  "phone_number": "0901234567",
  "date_of_birth": null,
  "gender": null,
  "address": null,
  "notes": null,
  "skin_type": null,
  "health_conditions": null,
  "is_active": true,
  "created_at": "2025-10-17T10:30:00Z",
  "updated_at": "2025-10-17T10:30:00Z",
  "deleted_at": null
}
```

**Errors:**

| Status          | Error                                    |
| --------------- | ---------------------------------------- |
| `404 Not Found` | Kh√°ch h√†ng kh√¥ng t√¨m th·∫•y ho·∫∑c ƒë√£ b·ªã x√≥a |

---

### 4Ô∏è‚É£ Update Customer

**C·∫≠p nh·∫≠t th√¥ng tin kh√°ch h√†ng (y√™u c·∫ßu authentication).**

```
PUT /customers/{customer_id}
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "full_name": "Nguy·ªÖn VƒÉn A Updated",
  "address": "456 ƒê∆∞·ªùng B, H√† N·ªôi",
  "notes": "∆Øa th√≠ch massage nh·∫π"
}
```

**Response (200 OK):**

```json
{
  "id": 1,
  "user_id": null,
  "full_name": "Nguy·ªÖn VƒÉn A Updated",
  "phone_number": "0901234567",
  "date_of_birth": null,
  "gender": null,
  "address": "456 ƒê∆∞·ªùng B, H√† N·ªôi",
  "notes": "∆Øa th√≠ch massage nh·∫π",
  "skin_type": null,
  "health_conditions": null,
  "is_active": true,
  "created_at": "2025-10-17T10:30:00Z",
  "updated_at": "2025-10-17T11:00:00Z",
  "deleted_at": null
}
```

**Notes:**

- ‚úÖ Partial update (ch·ªâ c·∫≠p nh·∫≠t fields ƒë∆∞·ª£c g·ª≠i)
- ‚úÖ JWT token b·∫Øt bu·ªôc
- ‚úÖ User ch·ªâ c√≥ th·ªÉ c·∫≠p nh·∫≠t h·ªì s∆° c·ªßa ch√≠nh m√¨nh (n·∫øu `user_id` tr√πng)

**Errors:**

| Status             | Error                     |
| ------------------ | ------------------------- |
| `401 Unauthorized` | No token                  |
| `403 Forbidden`    | User kh√¥ng s·ªü h·ªØu h·ªì s∆°   |
| `404 Not Found`    | Kh√°ch h√†ng kh√¥ng t√¨m th·∫•y |
| `409 Conflict`     | Phone number ƒë√£ t·ªìn t·∫°i   |

---

### 5Ô∏è‚É£ Delete Customer (Soft Delete - Lu·ªìng 4)

**X√≥a m·ªÅm kh√°ch h√†ng (ƒë·∫∑t `deleted_at`, kh√¥ng x√≥a vƒ©nh vi·ªÖn).**

```
DELETE /customers/{customer_id}
Authorization: Bearer <JWT_TOKEN>
```

**Response (200 OK):**

```json
{
  "message": "Kh√°ch h√†ng ƒë√£ b·ªã x√≥a",
  "can_restore": true
}
```

**Notes:**

- ‚úÖ JWT token b·∫Øt bu·ªôc
- ‚úÖ D·ªØ li·ªáu v·∫´n t·ªìn t·∫°i trong database
- ‚úÖ C√≥ th·ªÉ kh√¥i ph·ª•c sau (th√¥ng qua admin panel)

**Errors:**

| Status             | Error                                    |
| ------------------ | ---------------------------------------- |
| `401 Unauthorized` | No token                                 |
| `404 Not Found`    | Kh√°ch h√†ng kh√¥ng t√¨m th·∫•y ho·∫∑c ƒë√£ b·ªã x√≥a |

---

## üîÑ Lu·ªìng Nghi·ªáp V·ª•

### Lu·ªìng 1: Kh√°ch H√†ng V√£ng Lai ƒê·∫øn L·∫ßn ƒê·∫ßu

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Kh√°ch h√†ng v√£ng lai (kh√¥ng app, kh√¥ng t√†i kho·∫£n)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Spa staff t·∫°o kh√°ch h√†ng tr√™n app:                 ‚îÇ
‚îÇ POST /customers/walk-in                             ‚îÇ
‚îÇ {full_name, phone_number}                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Customer record t·∫°o v·ªõi user_id = NULL          ‚îÇ
‚îÇ - id: 1                                            ‚îÇ
‚îÇ - full_name: "Nguy·ªÖn VƒÉn A"                        ‚îÇ
‚îÇ - phone_number: "0901234567"                       ‚îÇ
‚îÇ - user_id: NULL (v√£ng lai)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Code:**

```python
# service.py
customer = service.create_walk_in_customer(
    db,
    full_name="Nguy·ªÖn VƒÉn A",
    phone_number="0901234567"
)
# ‚úÖ Returns Customer(id=1, user_id=None, ...)
```

---

### Lu·ªìng 2a: Kh√°ch H√†ng ƒêƒÉng K√Ω T√†i Kho·∫£n (T·ª´ V√£ng Lai)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Kh√°ch h√†ng v√£ng lai (ƒë√£ c√≥ record CRM)             ‚îÇ
‚îÇ Quy·∫øt ƒë·ªãnh ƒëƒÉng k√Ω t√†i kho·∫£n online                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Auth module: POST /auth/register                    ‚îÇ
‚îÇ {email, password}                                   ‚îÇ
‚îÇ ‚Üí T·∫°o User record (id: 5)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Customers module: T·∫°o stub customer v·ªõi user_id    ‚îÇ
‚îÇ create_online_customer_with_user(                  ‚îÇ
‚îÇ     db,                                             ‚îÇ
‚îÇ     user_id=5,                                      ‚îÇ
‚îÇ     full_name=None,                                 ‚îÇ
‚îÇ     phone_number=None                              ‚îÇ
‚îÇ )                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Stub Customer t·∫°o (Ch·ªù ho√†n th√†nh h·ªì s∆°)       ‚îÇ
‚îÇ - id: 2                                            ‚îÇ
‚îÇ - user_id: 5 (linked v·ªõi user)                     ‚îÇ
‚îÇ - full_name: NULL (ch∆∞a ho√†n th√†nh)                ‚îÇ
‚îÇ - phone_number: NULL (ch∆∞a ho√†n th√†nh)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Lu·ªìng 2b: Ho√†n Th√†nh H·ªì S∆°

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Kh√°ch h√†ng ƒë√£ ƒëƒÉng nh·∫≠p (c√≥ JWT token)             ‚îÇ
‚îÇ ƒêi·ªÅn th√™m th√¥ng tin h·ªì s∆°                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ POST /customers/profile                             ‚îÇ
‚îÇ Authorization: Bearer <JWT>                         ‚îÇ
‚îÇ {                                                   ‚îÇ
‚îÇ   full_name: "Nguy·ªÖn VƒÉn B",                       ‚îÇ
‚îÇ   phone_number: "0987654321",                      ‚îÇ
‚îÇ   date_of_birth: "1990-05-15",                     ‚îÇ
‚îÇ   ...                                               ‚îÇ
‚îÇ }                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Service: C·∫≠p nh·∫≠t stub customer                    ‚îÇ
‚îÇ complete_customer_profile(                         ‚îÇ
‚îÇ     db,                                             ‚îÇ
‚îÇ     customer_id=2,                                  ‚îÇ
‚îÇ     full_name="Nguy·ªÖn VƒÉn B",                      ‚îÇ
‚îÇ     phone_number="0987654321"                      ‚îÇ
‚îÇ )                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Stub Customer ƒë∆∞·ª£c c·∫≠p nh·∫≠t                      ‚îÇ
‚îÇ - id: 2                                            ‚îÇ
‚îÇ - user_id: 5                                       ‚îÇ
‚îÇ - full_name: "Nguy·ªÖn VƒÉn B" ‚úÖ (ƒê∆∞·ª£c set)          ‚îÇ
‚îÇ - phone_number: "0987654321" ‚úÖ (ƒê∆∞·ª£c set)         ‚îÇ
‚îÇ - C√°c field kh√°c: ƒê∆∞·ª£c c·∫≠p nh·∫≠t theo request      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Lu·ªìng 3: Li√™n K·∫øt Kh√°ch H√†ng C≈© V·ªõi T√†i Kho·∫£n M·ªõi

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Kh√°ch h√†ng c≈© (v√£ng lai, c√≥ record CRM)             ‚îÇ
‚îÇ + T√†i kho·∫£n online m·ªõi                              ‚îÇ
‚îÇ ‚Üí Mu·ªën link 2 h·ªì s∆° th√†nh 1                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Step 1: B·∫Øt ƒë·∫ßu linking (Lu·ªìng 3c)                 ‚îÇ
‚îÇ POST /customers/link (hypothetical)                 ‚îÇ
‚îÇ {phone_number: "0901234567"}                       ‚îÇ
‚îÇ ‚Üí T√¨m old customer v√† send OTP                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Step 2: X√°c minh OTP (Lu·ªìng 3d)                    ‚îÇ
‚îÇ POST /customers/verify-otp                         ‚îÇ
‚îÇ Authorization: Bearer <JWT>                         ‚îÇ
‚îÇ {                                                   ‚îÇ
‚îÇ   phone_number: "0901234567",                      ‚îÇ
‚îÇ   otp_code: "123456"                               ‚îÇ
‚îÇ }                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Service: Transaction (Atomic)                       ‚îÇ
‚îÇ verify_otp_and_link_account(                        ‚îÇ
‚îÇ     db,                                             ‚îÇ
‚îÇ     user_id=5,                                      ‚îÇ
‚îÇ     phone_number="0901234567",                      ‚îÇ
‚îÇ     otp_code="123456"                              ‚îÇ
‚îÇ )                                                   ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ Actions:                                            ‚îÇ
‚îÇ 1. Verify OTP                                       ‚îÇ
‚îÇ 2. Update old_customer.user_id = 5                 ‚îÇ
‚îÇ 3. Soft delete stub_customer                       ‚îÇ
‚îÇ 4. Commit transaction                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Linking th√†nh c√¥ng                              ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ OLD CUSTOMER (V√£ng lai)          STUB CUSTOMER    ‚îÇ
‚îÇ id: 1                             id: 2            ‚îÇ
‚îÇ full_name: "Nguy·ªÖn VƒÉn A"        full_name: NULL  ‚îÇ
‚îÇ phone: "0901234567"              phone: NULL      ‚îÇ
‚îÇ user_id: NULL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí    user_id: 5       ‚îÇ
‚îÇ                (Link)            deleted_at: ‚úÖ   ‚îÇ
‚îÇ                                  (Soft deleted)   ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ ‚Üí Kh√°ch h√†ng s·ª≠ d·ª•ng old_customer(id=1)           ‚îÇ
‚îÇ ‚Üí Stub customer(id=2) kh√¥ng c√≤n active             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Lu·ªìng 4: X√≥a Kh√°ch H√†ng (Soft Delete)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User y√™u c·∫ßu x√≥a t√†i kho·∫£n / h·ªì s∆° ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ DELETE /customers/{customer_id}      ‚îÇ
‚îÇ Authorization: Bearer <JWT>          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Service: Soft delete                ‚îÇ
‚îÇ delete_customer(db, customer_id)    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ Action: Set deleted_at = now()      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Customer "deleted"               ‚îÇ
‚îÇ - deleted_at: 2025-10-17T11:05:00Z ‚îÇ
‚îÇ - D·ªØ li·ªáu v·∫´n c√≥ trong DB           ‚îÇ
‚îÇ - Kh√¥ng hi·ªán trong GET endpoints    ‚îÇ
‚îÇ - C√≥ th·ªÉ kh√¥i ph·ª•c (admin)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Lu·ªìng 5: Kh√¥i Ph·ª•c Kh√°ch H√†ng (Admin)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Admin restore deleted customer       ‚îÇ
‚îÇ restore_customer(db, customer_id)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Action: Set deleted_at = NULL        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚úÖ Customer restored                ‚îÇ
‚îÇ - deleted_at: NULL                  ‚îÇ
‚îÇ - Quay tr·ªü l·∫°i ho·∫°t ƒë·ªông            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù V√≠ D·ª• S·ª≠ D·ª•ng

### Python (Requests)

#### 1. Create Walk-in Customer

```python
import requests

url = "http://localhost:8000/customers/walk-in"
payload = {
    "full_name": "Nguy·ªÖn VƒÉn A",
    "phone_number": "0901234567"
}
response = requests.post(url, json=payload)

if response.status_code == 200:
    customer = response.json()
    print(f"‚úÖ Customer created: {customer['id']}")
else:
    print(f"‚ùå Error: {response.json()['detail']}")
```

#### 2. Complete Profile (Authenticated)

```python
import requests

url = "http://localhost:8000/customers/profile"
headers = {
    "Authorization": f"Bearer {jwt_token}"
}
payload = {
    "full_name": "Nguy·ªÖn VƒÉn B",
    "phone_number": "0987654321",
    "date_of_birth": "1990-05-15",
    "gender": "nam",
    "address": "123 ƒê∆∞·ªùng A, TP HCM",
    "skin_type": "h·ªón h·ª£p",
    "health_conditions": "D·ªã ·ª©ng v·ªõi x√† ph√≤ng"
}
response = requests.post(url, json=payload, headers=headers)

if response.status_code == 200:
    print("‚úÖ Profile completed")
else:
    print(f"‚ùå Error: {response.json()['detail']}")
```

#### 3. Update Customer

```python
import requests

customer_id = 1
url = f"http://localhost:8000/customers/{customer_id}"
headers = {"Authorization": f"Bearer {jwt_token}"}
payload = {
    "notes": "∆Øa th√≠ch massage nh·∫π, tr√°nh v√πng vai"
}
response = requests.put(url, json=payload, headers=headers)

if response.status_code == 200:
    print("‚úÖ Customer updated")
else:
    print(f"‚ùå Error: {response.json()['detail']}")
```

#### 4. Get Customer

```python
import requests

customer_id = 1
url = f"http://localhost:8000/customers/{customer_id}"
response = requests.get(url)

if response.status_code == 200:
    customer = response.json()
    print(f"Name: {customer['full_name']}")
    print(f"Phone: {customer['phone_number']}")
    print(f"Skin Type: {customer['skin_type']}")
else:
    print("‚ùå Customer not found")
```

#### 5. Delete Customer

```python
import requests

customer_id = 1
url = f"http://localhost:8000/customers/{customer_id}"
headers = {"Authorization": f"Bearer {jwt_token}"}
response = requests.delete(url, headers=headers)

if response.status_code == 200:
    print(f"‚úÖ {response.json()['message']}")
else:
    print(f"‚ùå Error: {response.json()['detail']}")
```

### cURL

#### Create Walk-in Customer

```bash
curl -X POST "http://localhost:8000/customers/walk-in" \
  -H "Content-Type: application/json" \
  -d '{
    "full_name": "Nguy·ªÖn VƒÉn A",
    "phone_number": "0901234567"
  }'
```

#### Get Customer

```bash
curl -X GET "http://localhost:8000/customers/1"
```

#### Update Customer (with JWT)

```bash
curl -X PUT "http://localhost:8000/customers/1" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "notes": "∆Øa th√≠ch massage nh·∫π"
  }'
```

---

## ‚ö†Ô∏è X·ª≠ L√Ω L·ªói

### Custom Exceptions

```python
class CustomerNotFoundError(Exception):
    """Kh√°ch h√†ng kh√¥ng t√¨m th·∫•y."""
    pass

class PhoneNumberAlreadyExistsError(Exception):
    """S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i."""
    pass

class InvalidOTPError(Exception):
    """OTP kh√¥ng h·ª£p l·ªá ho·∫∑c h·∫øt h·∫°n."""
    pass

class AccountLinkingError(Exception):
    """L·ªói khi li√™n k·∫øt t√†i kho·∫£n."""
    pass
```

### Error Response Format

```json
{
  "detail": "S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i"
}
```

### HTTP Status Codes

| Code               | Meaning            | Th∆∞·ªùng g·∫∑p khi                            |
| ------------------ | ------------------ | ----------------------------------------- |
| `200 OK`           | Th√†nh c√¥ng         | GET, PUT, DELETE th√†nh c√¥ng               |
| `201 Created`      | T·∫°o th√†nh c√¥ng     | POST th√†nh c√¥ng                           |
| `400 Bad Request`  | Request sai format | Validation error (phone format sai, etc.) |
| `401 Unauthorized` | C·∫ßn authentication | Qu√™n g·ª≠i JWT token                        |
| `403 Forbidden`    | Kh√¥ng c√≥ quy·ªÅn     | User c·∫≠p nh·∫≠t h·ªì s∆° ng∆∞·ªùi kh√°c            |
| `404 Not Found`    | Kh√¥ng t√¨m th·∫•y     | Customer kh√¥ng t·ªìn t·∫°i                    |
| `409 Conflict`     | D·ªØ li·ªáu xung ƒë·ªôt   | Phone number tr√πng                        |
| `500 Server Error` | L·ªói server         | Database error, etc.                      |

---

## üéØ Best Practices

### 1. Validate Phone Numbers

**Lu√¥n normalize phone numbers:**

```python
from src.core.utils import normalize_phone_number

phone = normalize_phone_number("0901 234 567")
# Result: "0901234567"

phone = normalize_phone_number("+84 901 234 567")
# Result: "+84901234567"
```

### 2. Use Service Layer for Business Logic

‚ùå **Sai - Tr·ª±c ti·∫øp call CRUD:**

```python
@router.post("/customers/create")
def create(request: CustomerCreateRequest, db: Session):
    customer = crud.create_customer(
        db,
        full_name=request.full_name,
        phone_number=request.phone_number
    )
    return customer
```

‚úÖ **ƒê√∫ng - G·ªçi Service layer:**

```python
@router.post("/customers/walk-in")
def create_walk_in(request: CustomerCreateRequest, db: Session):
    try:
        customer = service.create_walk_in_customer(
            db,
            full_name=request.full_name,
            phone_number=request.phone_number
        )
        return customer
    except service.PhoneNumberAlreadyExistsError:
        raise HTTPException(status_code=409, detail="...")
```

### 3. Check Soft-Deleted Records

**Lu√¥n ki·ªÉm tra `deleted_at` khi l·∫•y records:**

```python
# ‚úÖ ƒê√∫ng - Exclude soft-deleted
customer = crud.get_customer_by_id(db, customer_id, include_deleted=False)

# ‚ùå Sai - C√≥ th·ªÉ l·∫•y deleted record
customer = db.query(Customer).filter(Customer.id == customer_id).first()
```

### 4. Use Transactions for Account Linking

**Lu√¥n d√πng transaction khi update multiple records:**

```python
try:
    old_customer.user_id = user_id
    stub_customer.deleted_at = get_utc_now()
    db.commit()  # Atomic operation
except Exception as e:
    db.rollback()  # Rollback n·∫øu c√≥ error
    raise
```

### 5. Implement Proper Authorization

**Ki·ªÉm tra ownership khi update:**

```python
# ‚úÖ User ch·ªâ c√≥ th·ªÉ c·∫≠p nh·∫≠t h·ªì s∆° c·ªßa ch√≠nh m√¨nh
if customer.user_id and customer.user_id != current_user.id:
    raise HTTPException(status_code=403, detail="Forbidden")
```

### 6. Log Important Operations

```python
import logging

logger = logging.getLogger(__name__)

logger.info(f"‚úì Kh√°ch h√†ng t·∫°o: ID={customer.id}, {full_name}")
logger.warning(f"‚ö†Ô∏è SƒêT tr√πng: {phone_number}")
logger.error(f"‚ùå L·ªói linking: {str(e)}")
```

### 7. Handle Pagination in Search

```python
customers, total, total_pages = service.search_customers(
    db,
    search_query="Nguy·ªÖn",
    page=1,
    per_page=20
)
print(f"Found {total} customers on {total_pages} pages")
```

---

## üìö Related Documentation

- **[DOCUMENTATION.md](./DOCUMENTATION.md)** - T√†i li·ªáu ch√≠nh d·ª± √°n
- **[AUTH_API_GUIDE.md](./AUTH_API_GUIDE.md)** - Auth module guide
- **[PRODUCT_BRIEF.md](./PRODUCT_BRIEF.md)** - Business requirements

---

**H·ªèi g√¨ kh√°c?** Xem Swagger API docs t·∫°i `http://localhost:8000/docs`
