# KẾ HOẠCH KỸ THUẬT: GỬI MAIL XÁC NHẬN ĐĂNG KÝ VÀ QUÊN MẬT KHẨU

## 1. Mô tả Ngữ cảnh

Triển khai tính năng gửi email xác nhận trong các quy trình quan trọng: đăng ký tài khoản mới và khôi phục mật khẩu quên. Hệ thống sẽ tạo token xác minh (verification token), gửi email chứa link xác nhận, và xác thực token khi người dùng click link.

## 2. Các Tệp và Hàm Liên quan

### Tạo mới:

- **`src/core/email.py`:** Module xử lý email

  - Hàm `send_verification_email(email: str, token: str) -> bool`: Gửi email xác nhận đăng ký
  - Hàm `send_password_reset_email(email: str, token: str) -> bool`: Gửi email đặt lại mật khẩu
  - Hàm `send_email_async(to_email: str, subject: str, html_content: str) -> bool`: Gửi email không đồng bộ (helper)

- **`src/core/config.py`:** Thêm cấu hình email (nếu chưa có)
  - `SMTP_SERVER: str` - Địa chỉ máy chủ SMTP
  - `SMTP_PORT: int` - Cổng SMTP
  - `SMTP_USER: str` - Username SMTP
  - `SMTP_PASSWORD: str` - Password SMTP
  - `SENDER_EMAIL: str` - Email gửi
  - `SENDER_NAME: str` - Tên người gửi
  - `VERIFICATION_TOKEN_EXPIRE_HOURS: int` - Thời gian hết hạn token (mặc định: 24h)
  - `RESET_TOKEN_EXPIRE_HOURS: int` - Thời gian hết hạn token reset (mặc định: 1h)

### Sửa đổi:

- **`src/modules/auth/models.py`:** Thêm bảng lưu token xác minh

  - Tạo model `VerificationToken(SQLModel, table=True)` với fields: `id`, `user_id`, `token`, `token_type`, `expires_at`, `created_at`
  - Hoặc tạo model `EmailToken(SQLModel, table=True)` generic cho cả verification và reset

- **`src/modules/auth/crud.py`:** Thêm hàm xử lý token

  - Hàm `create_verification_token(user_id: int, token_type: str) -> VerificationToken`: Tạo và lưu token xác minh
  - Hàm `get_verification_token(token: str) -> VerificationToken | None`: Lấy token từ DB
  - Hàm `verify_and_delete_token(token: str) -> bool`: Xác minh và xóa token
  - Hàm `delete_expired_tokens()`: Xóa token hết hạn (background task)

- **`src/modules/auth/service.py`:** Thêm logic xử lý email

  - Hàm `initiate_email_verification(user_id: int) -> bool`: Tạo token và gửi email
  - Hàm `confirm_email(token: str) -> dict`: Xác minh email từ token
  - Hàm `initiate_password_reset(email: str) -> bool`: Tạo reset token và gửi email
  - Hàm `confirm_password_reset(token: str, new_password: str) -> bool`: Đặt lại mật khẩu từ token

- **`src/modules/auth/router.py`:** Thêm endpoints

  - `POST /auth/verify-email`: Endpoint xác minh email (nhận token từ query param hoặc body)
  - `POST /auth/resend-verification-email`: Endpoint gửi lại email xác minh (đã đăng nhập)
  - `POST /auth/password-reset`: Endpoint yêu cầu đặt lại mật khẩu (gửi email)
  - `POST /auth/confirm-password-reset`: Endpoint xác minh token reset và đặt mật khẩu mới

- **`src/main.py`:** Thêm background task
  - Thêm Lifespan hoặc startup event để chạy periodic task xóa token hết hạn

### Tùy chọn (tuỳ theo yêu cầu):

- **`src/core/background_tasks.py`:** Nếu sử dụng Celery hoặc APScheduler cho background jobs
- **`src/core/email_templates.py`:** Template HTML cho email xác nhận và reset password

## 3. Thuật toán/Logic (Từng bước)

### 3.1 Luồng Đăng ký + Xác nhận Email

**Bước 1: Người dùng gửi yêu cầu đăng ký**

1. POST `/auth/register` với `email`, `password`, `full_name`
2. Validate dữ liệu (kiểm tra email không trùng lặp, password đủ mạnh)
3. Hash password bằng bcrypt
4. Tạo user với `is_active = False` trong DB
5. Gọi `initiate_email_verification(user_id)`:
   - Tạo token ngẫu nhiên (UUID hoặc 32 ký tự hex)
   - Lưu vào bảng VerificationToken với `token_type = 'EMAIL_VERIFICATION'` và `expires_at = now + 24h`
   - Gọi `send_verification_email(email, token)`:
     - Tạo HTML email chứa link: `https://yourdomain.com/auth/verify-email?token={token}`
     - Gửi email bằng SMTP (hoặc service bên thứ ba như Sendgrid)
     - Log hoặc cache token cho retry
   - Return `True` nếu thành công
6. Trả response `{"message": "Đăng ký thành công. Vui lòng xác minh email"}`

**Bước 2: Người dùng click link xác minh email**

1. GET/POST `/auth/verify-email?token={token}` hoặc body `{"token": "{token}"}`
2. Gọi `confirm_email(token)`:
   - Query bảng VerificationToken với token
   - Kiểm tra token tồn tại
   - Kiểm tra `expires_at > now` (chưa hết hạn)
   - Kiểm tra `token_type == 'EMAIL_VERIFICATION'`
   - Lấy `user_id` từ token record
   - Update user: `is_active = True`, `email_verified_at = now`
   - Xóa token record
   - Commit transaction
   - Return `{"message": "Email xác minh thành công"}`
3. Nếu token invalid hoặc hết hạn: Return error 400

**Bước 3: Gửi lại email xác minh (Optional)**

1. POST `/auth/resend-verification-email` (require authentication)
2. Kiểm tra user `is_active == False` (chưa xác minh)
3. Xóa token cũ nếu tồn tại
4. Gọi `initiate_email_verification(user_id)` lại
5. Return success message

### 3.2 Luồng Quên Mật khẩu + Đặt lại

**Bước 1: Người dùng yêu cầu đặt lại mật khẩu**

1. POST `/auth/password-reset` với `email`
2. Query user theo email
3. Gọi `initiate_password_reset(email)`:
   - Nếu user không tồn tại: **NGẪU NHIÊN DELAY 1-2 giây** và trả success (chống enumeration attack)
   - Nếu user tồn tại:
     - Tạo reset token (UUID hoặc 32 ký tự hex)
     - Lưu vào bảng VerificationToken với `token_type = 'PASSWORD_RESET'` và `expires_at = now + 1h`
     - Gọi `send_password_reset_email(email, token)`:
       - Tạo HTML email chứa link: `https://yourdomain.com/auth/reset-password?token={token}`
       - Gửi email bằng SMTP
     - Luôn return `True`
4. Trả response `{"message": "Nếu email tồn tại, email đặt lại mật khẩu sẽ được gửi"}`

**Bước 2: Người dùng click link reset và submit mật khẩu mới**

1. POST `/auth/confirm-password-reset` với `token` và `new_password`
2. Gọi `confirm_password_reset(token, new_password)`:
   - Query token từ bảng VerificationToken
   - Kiểm tra token tồn tại
   - Kiểm tra `expires_at > now` (chưa hết hạn)
   - Kiểm tra `token_type == 'PASSWORD_RESET'`
   - Lấy `user_id` từ token record
   - Validate `new_password` (độ dài tối thiểu, độ phức tạp)
   - Hash `new_password` bằng bcrypt
   - Update user: `password_hash = new_hash`, `password_updated_at = now`
   - Revoke tất cả refresh tokens cũ của user (xóa khỏi bảng RefreshToken)
   - Xóa token record
   - Commit transaction
   - Return `{"message": "Mật khẩu đã được đặt lại thành công"}`
3. Nếu token invalid hoặc hết hạn: Return error 400

### 3.3 Xử lý Token hết hạn

**Background Task (chạy mỗi giờ hoặc mỗi ngày)**

1. Query tất cả token từ VerificationToken với `expires_at < now`
2. Xóa những token đó khỏi DB
3. Log số token đã xóa

### 3.4 Xử lý Lỗi & Edge Cases

| Tình Huống                             | Xử lý                                                       |
| :------------------------------------- | :---------------------------------------------------------- |
| Email không hợp lệ                     | Return 400 với message: "Email không hợp lệ"                |
| Email đã đăng ký                       | Return 400 với message: "Email đã tồn tại"                  |
| Token không tồn tại                    | Return 400 với message: "Link không hợp lệ hoặc đã hết hạn" |
| Token hết hạn                          | Return 400 với message: "Link không hợp lệ hoặc đã hết hạn" |
| Gửi email thất bại                     | Log error, return 500 nhưng không expose chi tiết lỗi SMTP  |
| User yêu cầu verify lại khi đã verify  | Return 400 hoặc 409 "Tài khoản đã được xác minh"            |
| Password reset cho email không tồn tại | Delay 1-2s rồi return success (chống enumeration)           |

### 3.5 Cấu trúc Bảng VerificationToken

```sql
CREATE TABLE verification_token (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
    token VARCHAR(64) NOT NULL UNIQUE,
    token_type VARCHAR(20) NOT NULL,  -- 'EMAIL_VERIFICATION' hoặc 'PASSWORD_RESET'
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_token (token),
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at)
);
```

### 3.6 Email Template Cấu trúc

**Verification Email:**

- Tiêu đề: "Xác minh email của bạn"
- Nội dung: Chào mừng + link xác minh + lưu ý hạn hữu dụng (24h)
- CTA: Button "Xác minh Email"
- Footer: Thông tin liên lạc + disclaimer

**Reset Password Email:**

- Tiêu đề: "Đặt lại mật khẩu của bạn"
- Nội dung: Yêu cầu reset + link + lưu ý hạn hữu dụng (1h) + cảnh báo bảo mật
- CTA: Button "Đặt lại Mật khẩu"
- Footer: Thông tin liên lạc + disclaimer + lưu ý an toàn
