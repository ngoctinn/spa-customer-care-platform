# KẾ HOẠCH KỸ THUẬT: Endpoint Tự Cập Nhật Ảnh Đại Diện

## 1. Mô tả Ngữ cảnh

- **Tính năng:** Cho phép một khách hàng đã xác thực (đăng nhập) có thể tự tải lên hoặc thay đổi ảnh đại diện của chính mình.
- **Mục tiêu:** Tạo một endpoint mới `POST /media/customers/me/avatar` an toàn và tiện lợi. Endpoint này sẽ tự động xác định khách hàng dựa trên JWT token thay vì yêu cầu `customer_id` trên đường dẫn URL, giúp tăng cường bảo mật và cải thiện trải nghiệm người dùng.

## 2. Các Tệp và Hàm Liên quan

### Các tệp cần THAY ĐỔI

1.  **`src/modules/media/router.py`**
    - **Tạo Endpoint Mới:** Thêm một endpoint mới vào router của module `media`.
      ```python
      @router.post(
          "/customers/me/avatar",
          response_model=MediaResponse,
          summary="Tự tải lên ảnh đại diện của tôi",
      )
      async def upload_my_customer_avatar(
          file: UploadFile = File(...),
          current_user: User = Depends(get_current_user),
          session: Session = Depends(get_session),
      ):
          # Logic sẽ được triển khai ở đây
      ```

### Các tệp được SỬ DỤNG (Không cần thay đổi)

1.  **`src/modules/media/service.py`**
    - Sẽ tái sử dụng hàm `upload_avatar_for_customer` đã có.
2.  **`src/modules/customers/crud.py`**
    - Sẽ sử dụng hàm `get_customer_by_user_id` để tìm hồ sơ khách hàng từ `user_id` của người dùng đang đăng nhập.

## 3. Thuật toán/Logic (Từng bước)

Luồng xử lý cho endpoint `POST /media/customers/me/avatar`:

1.  **Nhận Request:** Endpoint nhận request với file ảnh trong body và JWT token trong header `Authorization`.

2.  **Xác thực User:** Dependency `Depends(get_current_user)` tự động xác thực JWT token và trả về đối tượng `User` tương ứng. Nếu token không hợp lệ, request sẽ bị từ chối với lỗi 401.

3.  **Tìm Hồ sơ Khách hàng:**
    a. Bên trong hàm của endpoint, gọi `crud.customer.get_customer_by_user_id(db=session, user_id=current_user.id)`.
    b. Thao tác này sẽ lấy ra hồ sơ `Customer` được liên kết với `User` đang đăng nhập.
    c. **Kiểm tra:** Nếu không tìm thấy hồ sơ `Customer` (trả về `None`), hệ thống sẽ trả về lỗi `HTTPException` 404 Not Found với thông báo "Hồ sơ khách hàng không tồn tại".

4.  **Gọi Service Tải ảnh lên:**
    a. Nếu tìm thấy hồ sơ `Customer`, lấy `customer.id`.
    b. Gọi hàm service đã có sẵn: `await upload_avatar_for_customer(customer_id=customer.id, file=file, session=session)`.
    c. Hàm service này sẽ đảm nhiệm toàn bộ logic còn lại: kiểm tra file, tải lên Supabase, và tạo record trong bảng `MediaFile`.

5.  **Trả về Phản hồi:** Endpoint trả về `MediaResponse` (chứa thông tin ảnh vừa tải lên) mà hàm service đã xử lý và trả về.
