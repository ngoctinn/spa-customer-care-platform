# KẾ HOẠCH KỸ THUẬT: XÁC THỰC VÀ QUẢN LÝ PHIÊN

## 1. Mô tả Ngữ cảnh

Triển khai hệ thống xác thực người dùng an toàn với JWT Access Token, Opaque Refresh Token, và RBAC cho backend FastAPI. Bao gồm đăng ký, xác minh email, đăng nhập, gia hạn phiên, đăng xuất, và khôi phục mật khẩu.

## 2. Các Tệp và Hàm Liên quan

- **Tạo mới:**

  - `src/modules/auth/models.py`: Định nghĩa model User với table=True, bao gồm email, password_hash, roles, is_active.
  - `src/modules/auth/schemas.py`: Pydantic schemas cho RegisterRequest, LoginRequest, TokenResponse, UserResponse.
  - `src/modules/auth/crud.py`: Hàm get_user_by_email, create_user, update_user, revoke_refresh_tokens.
  - `src/modules/auth/service.py`: Hàm hash_password, verify_password, create_access_token, create_refresh_token, verify_refresh_token, send_verification_email, send_reset_email.
  - `src/modules/auth/router.py`: APIRouter với endpoints /register, /verify, /login, /refresh, /logout, /password-reset-request, /password-reset.
  - `src/core/config.py`: Thêm settings cho JWT_SECRET_KEY, REFRESH_TOKEN_EXPIRE_DAYS, SMTP settings nếu chưa có.

- **Sửa đổi:**
  - `src/core/security.py`: Thêm hàm create_jwt_token, decode_jwt_token, hash_password, verify_password.
  - `src/core/dependencies.py`: Thêm get_current_user (Dependency để lấy User từ JWT), require_roles (Dependency kiểm tra roles).
  - `src/main.py`: Gắn auth_router vào app.

## 3. Thuật toán/Logic (Từng bước)

- **Đăng ký:** 1. Validate input. 2. Hash password. 3. Tạo User với is_active=False. 4. Tạo verification token (UUID). 5. Lưu token vào DB. 6. Gửi email. 7. Trả response.
- **Xác minh email:** 1. Nhận token. 2. Query token từ DB. 3. Kiểm tra TTL và chưa dùng. 4. Set user.is_active=True. 5. Xóa token. 6. Commit.
- **Đăng nhập:** 1. Validate credentials. 2. Kiểm tra is_active. 3. Tạo access_token (JWT với user_id, roles, exp). 4. Tạo refresh_token (UUID). 5. Lưu refresh_token vào DB/Redis. 6. Set HTTP-only cookie. 7. Trả access_token.
- **Gia hạn:** 1. Nhận refresh_token từ cookie. 2. Validate token trong DB/Redis. 3. Tạo access_token mới. 4. Trả access_token.
- **Đăng xuất:** 1. Nhận refresh_token từ cookie. 2. Xóa token khỏi DB/Redis. 3. Clear cookie.
- **Yêu cầu reset mật khẩu:** 1. Nhận email. 2. Tạo reset_token. 3. Lưu token. 4. Gửi email (luôn trả success để chống enumeration).
- **Đặt lại mật khẩu:** 1. Nhận token và new_password. 2. Validate token. 3. Hash new_password. 4. Update user. 5. Revoke tất cả refresh_tokens của user. 6. Xóa reset_token.
- **RBAC:** 1. get_current_user: Decode JWT, query User. 2. require_roles: So sánh user.roles với required_roles, raise 403 nếu không match.</content>
  <parameter name="filePath">e:\Projects\KLTN\back-end\docs\features\0001_PLAN.md
