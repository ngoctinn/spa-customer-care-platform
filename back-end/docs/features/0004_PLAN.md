# KẾ HOẠCH KỸ THUẬT: MODULE QUẢN LÝ HÌNH ẢNH (MEDIA)

## 1. Mô Tả Ngữ cảnh

Triển khai một module `media` chuyên dụng để xử lý tải lên, lưu trữ, truy xuất và xóa hình ảnh. Module sẽ tích hợp với **Supabase Storage** để lưu trữ file và sử dụng bảng PostgreSQL để quản lý metadata, giúp liên kết ảnh với các đối tượng khác trong hệ thống (khách hàng, dịch vụ, nhân viên).

---

## 2. Các Tệp và Hàm Liên quan

### 2.1 Sửa đổi Tệp Cấu hình

**`src/core/config.py`**

- Bổ sung các biến môi trường cho Supabase:
  - `SUPABASE_URL: str` - URL của dự án Supabase
  - `SUPABASE_KEY: str` - API Key công khai của Supabase
  - `SUPABASE_BUCKET_NAME: str` - Tên bucket lưu trữ (mặc định: "spa-images")
  - `MAX_FILE_SIZE: int` - Kích thước file tối đa (mặc định: 5MB)

**`requirements.txt`**

- Thêm thư viện: `supabase` (v1.0.0 trở lên)

### 2.2 Tạo mới Module `core/storage.py`

File core để khởi tạo Supabase client và xử lý thao tác file.

**Hàm `get_storage_client() -> Client`**

- Khởi tạo và trả về Supabase client
- Sử dụng caching để tái sử dụng client singleton
- Xử lý lỗi kết nối

**Hàm `upload_file_to_storage(file: BinaryIO, file_path: str) -> str`**

- Tải file lên bucket Supabase
- Tham số: `file` (file object), `file_path` (đường dẫn đích)
- Trả về: URL công khai của file
- Xử lý: Validasi MIME type, kiểm tra kích thước
- Ngoại lệ: `StorageException` nếu tải lên thất bại

**Hàm `delete_file_from_storage(file_path: str) -> bool`**

- Xóa file khỏi bucket Supabase
- Tham số: `file_path` (đường dẫn file trong bucket)
- Trả về: `True` nếu xóa thành công
- Ngoại lệ: `StorageException` nếu file không tìm thấy

**Hàm `get_public_url(file_path: str) -> str`**

- Lấy URL công khai của file
- Tham số: `file_path` (đường dẫn file)
- Trả về: URL công khai đầy đủ

### 2.3 Tạo mới Module `src/modules/media/models.py`

Định nghĩa SQLModel `MediaFile` để lưu metadata ảnh.

**Model `MediaFile`**

- `id: int` - Primary key
- `file_path: str` - Đường dẫn file trong Supabase (ví dụ: `customers/123/avatar_1665993600.jpg`)
- `public_url: str` - URL công khai để truy cập ảnh
- `file_type: str` - MIME type (ví dụ: `image/jpeg`)
- `file_size: int` - Kích thước file (bytes)
- `owner_id: int | None` - ID người tải lên (nullable)
- `related_entity_id: int | None` - ID của đối tượng liên quan (ví dụ: `customer_id`)
- `related_entity_type: str | None` - Loại đối tượng (`customer`, `service`, `staff`)
- `created_at: datetime` - Thời điểm tạo (tự động)
- `updated_at: datetime` - Thời điểm cập nhật (tự động)

Ràng buộc:

- `file_path` là unique
- Index trên `related_entity_id` và `related_entity_type` để truy vấn nhanh

### 2.4 Tạo mới Module `src/modules/media/schemas.py`

Pydantic schemas cho request/response.

**Schema `MediaUploadRequest`**

- Nhận từ client (form-data)
- Trường: `file` (UploadFile)

**Schema `MediaResponse`**

- Trả về sau khi tải lên hoặc xóa
- Trường:
  - `id: int`
  - `file_path: str`
  - `public_url: str`
  - `file_type: str`
  - `file_size: int`
  - `related_entity_type: str | None`
  - `related_entity_id: int | None`
  - `created_at: datetime`

**Schema `MediaListResponse`**

- Trả về danh sách ảnh
- Trường: `media_list: list[MediaResponse]`

### 2.5 Tạo mới Module `src/modules/media/service.py`

Chứa logic nghiệp vụ cho module media.

**Hàm `upload_avatar_for_customer(customer_id: int, file: UploadFile, session: Session) -> MediaResponse`**

- Tải ảnh đại diện cho khách hàng
- Tham số: `customer_id`, `file`, `session`
- Logic:
  1. Kiểm tra khách hàng tồn tại
  2. Tạo đường dẫn duy nhất: `customers/{customer_id}/avatar_{timestamp}.{ext}`
  3. Tải file lên Supabase (gọi `upload_file_to_storage`)
  4. Lấy URL công khai (gọi `get_public_url`)
  5. Tạo record `MediaFile` trong DB
  6. (Tùy chọn) Cập nhật `avatar_url` của customer
  7. Trả về `MediaResponse`
- Ngoại lệ: `HTTPException` (404 nếu khách hàng không tìm thấy, 400 nếu file không hợp lệ)

**Hàm `upload_image_for_service(service_id: int, file: UploadFile, session: Session) -> MediaResponse`**

- Tải ảnh cho dịch vụ (tương tự upload avatar)
- Đường dẫn: `services/{service_id}/image_{timestamp}.{ext}`
- (Tùy chọn) Cập nhật `image_url` của service

**Hàm `delete_media_file(media_id: int, session: Session) -> dict`**

- Xóa ảnh khỏi Supabase và DB
- Logic:
  1. Tìm record `MediaFile` bằng `media_id`
  2. Kiểm tra tồn tại (404 nếu không)
  3. Bắt đầu transaction
  4. Xóa file từ Supabase (gọi `delete_file_from_storage`)
  5. Xóa record từ DB
  6. Commit transaction
  7. Trả về `{"message": "Xóa ảnh thành công"}`
- Ngoại lệ: `HTTPException` (404 nếu không tìm thấy)

**Hàm `get_media_for_entity(entity_type: str, entity_id: int, session: Session) -> MediaListResponse`**

- Lấy danh sách ảnh của một đối tượng
- Truy vấn: `SELECT * FROM mediafile WHERE related_entity_type = ? AND related_entity_id = ?`
- Trả về: Danh sách `MediaResponse`

### 2.6 Tạo mới Module `src/modules/media/crud.py`

Chứa các thao tác trực tiếp với DB.

**Hàm `create_media_record(file_path: str, public_url: str, file_type: str, file_size: int, owner_id: int | None, related_entity_id: int | None, related_entity_type: str | None, session: Session) -> MediaFile`**

- Tạo record mới trong bảng `mediafile`
- Trả về: `MediaFile` object
- Commit trong session

**Hàm `get_media_by_id(media_id: int, session: Session) -> MediaFile | None`**

- Lấy một record theo ID

**Hàm `get_media_list_by_entity(entity_type: str, entity_id: int, session: Session) -> list[MediaFile]`**

- Lấy danh sách ảnh của một đối tượng

**Hàm `delete_media_record(media_id: int, session: Session) -> bool`**

- Xóa một record trong DB
- Trả về: `True` nếu xóa thành công

### 2.7 Tạo mới Module `src/modules/media/router.py`

Định nghĩa các API endpoints.

**Endpoint `POST /media/upload/customer-avatar/{customer_id}`**

- Tải ảnh đại diện cho khách hàng
- Request: `multipart/form-data` với field `file`
- Response: `MediaResponse` (status 200)
- Dependency: JWT token (authenticated user)
- Xử lý: Gọi `upload_avatar_for_customer`

**Endpoint `POST /media/upload/service-image/{service_id}`**

- Tải ảnh cho dịch vụ
- Request: `multipart/form-data` với field `file`
- Response: `MediaResponse` (status 200)
- Dependency: JWT token (authenticated user)
- Xử lý: Gọi `upload_image_for_service`

**Endpoint `DELETE /media/{media_id}`**

- Xóa một ảnh
- Response: `{"message": "Xóa ảnh thành công"}` (status 200)
- Dependency: JWT token (authenticated user)
- Xử lý: Gọi `delete_media_file`

**Endpoint `GET /media/entity/{entity_type}/{entity_id}`**

- Lấy danh sách ảnh của một đối tượng
- Response: `MediaListResponse` (status 200)
- Query params: `entity_type` (customer|service|staff), `entity_id` (int)
- Dependency: JWT token (optional)
- Xử lý: Gọi `get_media_for_entity`

### 2.8 Sửa đổi `src/main.py`

- Import `media_router` từ `modules.media.router`
- Gắn router vào ứng dụng FastAPI:
  ```python
  app.include_router(media_router, prefix="/api/v1", tags=["media"])
  ```

### 2.9 Tạo mới Migration Alembic

**`alembic/versions/*_create_mediafile_table.py`**

- Tạo bảng `mediafile` với các cột định nghĩa ở mục 2.3
- Tạo index trên `related_entity_id` và `related_entity_type`
- Thiết lập constraint unique trên `file_path`

---

## 3. Thuật toán/Logic (Từng bước)

### 3.1 Luồng Tải Ảnh Đại Diện Cho Khách Hàng

**Bước 1: Request từ Client**

- Client gửi `POST` request đến `/api/v1/media/upload/customer-avatar/{customer_id}`
- Header: `Authorization: Bearer <JWT_TOKEN>`
- Body: `multipart/form-data` với field `file`

**Bước 2: Validation tại Router**

1. Kiểm tra JWT token (authentication)
2. Kiểm tra `customer_id` có phải số nguyên dương
3. Kiểm tra file tồn tại trong request
4. Kiểm tra MIME type: chỉ cho phép ảnh (image/jpeg, image/png, image/webp, v.v.)
5. Kiểm tra kích thước file ≤ `MAX_FILE_SIZE` (5MB)

**Bước 3: Xử lý tại Service**

1. Gọi hàm `upload_avatar_for_customer(customer_id, file, session)`
2. **Kiểm tra khách hàng:** Truy vấn DB tìm customer với ID đã cho
   - Nếu không tìm thấy: raise `HTTPException(status_code=404)`
3. **Tạo đường dẫn file duy nhất:**
   ```
   file_extension = file.filename.split('.')[-1]
   timestamp = int(time.time() * 1000)  # milliseconds để tránh trùng lặp
   file_path = f"customers/{customer_id}/avatar_{timestamp}.{file_extension}"
   ```
4. **Tải file lên Supabase:**
   - Gọi `upload_file_to_storage(file.file, file_path)`
   - Xử lý exception `StorageException`
5. **Lấy URL công khai:**
   - Gọi `get_public_url(file_path)`
6. **Lưu metadata vào DB:**
   - Gọi `create_media_record(...)` từ CRUD
   - Lưu: `file_path`, `public_url`, `file_type` (từ `file.content_type`), `file_size`, `related_entity_id=customer_id`, `related_entity_type='customer'`
7. **(Tùy chọn) Cập nhật customer:**
   - Cập nhật `customer.avatar_url = public_url`
   - Commit DB session

**Bước 4: Response**

- Trả về `MediaResponse` với status 200:
  ```json
  {
    "id": 1,
    "file_path": "customers/123/avatar_1665993600000.jpg",
    "public_url": "https://<project>.supabase.co/storage/v1/object/public/spa-images/customers/123/avatar_1665993600000.jpg",
    "file_type": "image/jpeg",
    "file_size": 204800,
    "related_entity_type": "customer",
    "related_entity_id": 123,
    "created_at": "2025-10-17T12:00:00"
  }
  ```

### 3.2 Luồng Xóa Ảnh

**Bước 1: Request từ Client**

- Client gửi `DELETE` request đến `/api/v1/media/{media_id}`
- Header: `Authorization: Bearer <JWT_TOKEN>`

**Bước 2: Validation tại Router**

1. Kiểm tra JWT token (authentication)
2. Kiểm tra `media_id` có phải số nguyên dương

**Bước 3: Xử lý tại Service**

1. Gọi hàm `delete_media_file(media_id, session)`
2. **Tìm record trong DB:**
   - Truy vấn: `SELECT * FROM mediafile WHERE id = ?`
   - Nếu không tìm thấy: raise `HTTPException(status_code=404, detail="Media không tìm thấy")`
3. **Bắt đầu transaction DB**
4. **Xóa file từ Supabase:**
   - Gọi `delete_file_from_storage(media_record.file_path)`
   - Nếu exception xảy ra: rollback transaction, raise exception
5. **Xóa record từ DB:**
   - Gọi `delete_media_record(media_id, session)` từ CRUD
6. **Commit transaction**

**Bước 4: Response**

- Trả về status 200 với body:
  ```json
  {
    "message": "Xóa ảnh thành công"
  }
  ```

### 3.3 Luồng Lấy Danh Sách Ảnh

**Bước 1: Request từ Client**

- Client gửi `GET` request đến `/api/v1/media/entity/{entity_type}/{entity_id}`
- Header: `Authorization: Bearer <JWT_TOKEN>` (optional)

**Bước 2: Validation**

1. Kiểm tra `entity_type` trong danh sách hợp lệ (`customer`, `service`, `staff`)
2. Kiểm tra `entity_id` là số nguyên dương

**Bước 3: Xử lý tại Service**

1. Gọi hàm `get_media_for_entity(entity_type, entity_id, session)`
2. **Truy vấn DB:**
   ```sql
   SELECT * FROM mediafile
   WHERE related_entity_type = ? AND related_entity_id = ?
   ORDER BY created_at DESC
   ```
3. **Trả về danh sách:** Map mỗi record thành `MediaResponse`

**Bước 4: Response**

- Trả về status 200 với body:
  ```json
  {
    "media_list": [
      {
        "id": 1,
        "file_path": "customers/123/avatar_1665993600000.jpg",
        "public_url": "https://...",
        "file_type": "image/jpeg",
        "file_size": 204800,
        "related_entity_type": "customer",
        "related_entity_id": 123,
        "created_at": "2025-10-17T12:00:00"
      }
    ]
  }
  ```

---

## 4. Các Ràng Buộc Không Chức Năng

- **Hiệu suất:** Sử dụng index DB để truy vấn danh sách ảnh nhanh
- **Bảo mật:** Yêu cầu JWT token cho tất cả các endpoint
- **Độ tin cây:** Sử dụng transaction để đảm bảo tính toàn vẹn dữ liệu khi xóa
- **Khả năng mở rộng:** Tách biệt logic Supabase trong `core/storage.py` để có thể thay đổi provider sau này
