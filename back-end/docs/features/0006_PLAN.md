# KẾ HOẠCH KỸ THUẬT (Bản triển khai): MODULE CATALOG

## 1. Mô tả Ngữ cảnh

- **Tên module:** `catalog`.
- **Tính năng:** Xây dựng module quản lý toàn bộ danh mục sản phẩm, dịch vụ của spa.
- **Phạm vi:** Cung cấp các API để thực hiện thao tác CRUD (Tạo, Đọc, Cập nhật, Xóa) trên các thực thể dữ liệu sau: Sản phẩm, Dịch vụ, Gói liệu trình, và các Danh mục tương ứng của chúng.
- **Mục tiêu:** Tạo một cấu trúc dữ liệu chi tiết và các endpoint cần thiết để lưu trữ và truy xuất thông tin về các sản phẩm/dịch vụ mà spa cung cấp.

## 2. Các Tệp và Hàm Liên quan

### `src/modules/services/models.py` - Cấu trúc dữ liệu chi tiết

- **Model `ProductCategory(SQLModel, table=True)`**

  - `id: Optional[int]` = Field(default=None, primary_key=True)
  - `name: str` = Field(index=True)
  - `description: str`
  - `products: List["Product"]` = Relationship(back_populates="category")

- **Model `Product(SQLModel, table=True)`**

  - `id: Optional[int]` = Field(default=None, primary_key=True)
  - `name: str`
  - `sku: str` = Field(unique=True, index=True)
  - `brand: str`
  - `description: str`
  - `price: float`
  - `stock_quantity: int`
  - `low_stock_threshold: int`
  - `category_id: Optional[int]` = Field(default=None, foreign_key="productcategory.id")
  - `category: Optional[ProductCategory]` = Relationship(back_populates="products")

- **Model `ServiceCategory(SQLModel, table=True)`**

  - `id: Optional[int]` = Field(default=None, primary_key=True)
  - `name: str` = Field(index=True)
  - `description: str`
  - `services: List["Service"]` = Relationship(back_populates="category")

- **Model `Service(SQLModel, table=True)`**

  - `id: Optional[int]` = Field(default=None, primary_key=True)
  - `name: str`
  - `description: str`
  - `price: float`
  - `duration_minutes: int`
  - `buffer_time_after: int`
  - `is_bookable_online: bool` = Field(default=True)
  - `color_code: str` = Field(default="#FFFFFF")
  - `required_resources: List[str]` = Field(sa_column=Column(JSON), default_factory=list)
  - `required_staff_skills: List[str]` = Field(sa_column=Column(JSON), default_factory=list)
  - `category_id: Optional[int]` = Field(default=None, foreign_key="servicecategory.id")
  - `category: Optional[ServiceCategory]` = Relationship(back_populates="services")
  - `packages: List["ServicePackage"]` = Relationship(back_populates="services", link_model=PackageServiceLink)

- **Model `PackageCategory(SQLModel, table=True)`**

  - `id: Optional[int]` = Field(default=None, primary_key=True)
  - `name: str` = Field(index=True)
  - `description: str`
  - `packages: List["ServicePackage"]` = Relationship(back_populates="category")

- **Model `PackageServiceLink(SQLModel, table=True)`** (Bảng trung gian)

  - `package_id: Optional[int]` = Field(default=None, foreign_key="servicepackage.id", primary_key=True)
  - `service_id: Optional[int]` = Field(default=None, foreign_key="service.id", primary_key=True)

- **Model `ServicePackage(SQLModel, table=True)`**
  - `id: Optional[int]` = Field(default=None, primary_key=True)
  - `name: str`
  - `description: str`
  - `total_price: float`
  - `validity_period_days: int`
  - `terms_and_cond
  - itions: str`
  - `category_id: Optional[int]` = Field(default=None, foreign_key="packagecategory.id")
  - `category: Optional[PackageCategory]` = Relationship(back_populates="packages")
  - `services: List[Service]` = Relationship(back_populates="packages", link_model=PackageServiceLink)

### Các tệp khác (`schemas.py`, `crud.py`, `router.py`)

- Các tệp này sẽ được tạo để cung cấp logic và endpoint cho việc thực hiện CRUD trên tất cả các model đã định nghĩa ở trên. Mỗi model sẽ có bộ schema (Create, Read, Update) và các hàm CRUD tương ứng. Router sẽ expose các endpoint cần thiết.

## 3. Thuật toán/Logic (Trong phạm vi Module)

- **Logic tạo/cập nhật thực thể có danh mục (Product, Service, ServicePackage):**

  1.  Khi nhận yêu cầu tạo/cập nhật một đối tượng (ví dụ: `Product`) với một `category_id`.
  2.  Hàm trong `service.py` phải truy vấn bảng danh mục tương ứng (ví dụ: `ProductCategory`) để xác thực `category_id` là hợp lệ.
  3.  Nếu không hợp lệ, trả về lỗi `404 Not Found` với thông báo "Category not found".
  4.  Nếu hợp lệ, tiếp tục tạo/cập nhật đối tượng.

- **Logic tạo/cập nhật `ServicePackage`:**

  1.  Khi nhận yêu cầu tạo/cập nhật một `ServicePackage` với một danh sách `service_ids`.
  2.  Hàm trong `service.py` phải lặp qua danh sách `service_ids`.
  3.  Với mỗi `service_id`, truy vấn bảng `Service` để đảm bảo dịch vụ tồn tại. Nếu bất kỳ ID nào không hợp lệ, trả về lỗi.
  4.  Sau khi xác thực tất cả `service_ids`, tiến hành tạo/cập nhật bản ghi `ServicePackage`.
  5.  Xóa các liên kết cũ trong `PackageServiceLink` (nếu là cập nhật) và tạo các liên kết mới dựa trên danh sách `service_ids` được cung cấp.

- **Logic truy vấn lồng nhau:**
  1.  Cần tạo các endpoint để truy vấn các đối tượng con của một danh mục.
  2.  Ví dụ: `GET /service-categories/{category_id}/services`.
  3.  Endpoint này sẽ gọi hàm `crud.service.get_multi_by_category(category_id=...)` để lấy tất cả dịch vụ thuộc về danh mục đó.
