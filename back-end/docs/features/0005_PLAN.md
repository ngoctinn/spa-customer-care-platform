# Kế hoạch Kỹ thuật: Xây dựng Bộ Kiểm thử cho các Module

## 1. Mô tả Ngữ cảnh

Mục tiêu là xây dựng một bộ kiểm thử tích hợp (integration tests) toàn diện cho các module `auth`, `customers`, và `media` bằng `pytest` và `TestClient` của FastAPI. Kế hoạch này sẽ vạch ra các trường hợp cần kiểm thử (test cases) để đảm bảo các endpoints hoạt động đúng như mong đợi, xử lý lỗi chính xác và có độ bao phủ cao.

Việc này giúp tăng độ ổn định của hệ thống, ngăn ngừa lỗi hồi quy (regressions) và tự động hóa quy trình kiểm tra chất lượng code.

## 2. Các Tệp và Hàm Liên quan

Kế hoạch này sẽ tập trung vào việc **TẠO MỚI** và **CẬP NHẬT** các tệp kiểm thử sau:

- **`tests/test_auth.py` (Tạo mới):** Kiểm thử toàn bộ luồng xác thực người dùng.
- **`tests/test_customers.py` (Cập nhật):** Mở rộng file có sẵn để kiểm thử các API của module khách hàng.
- **`tests/test_media.py` (Cập nhật):** Mở rộng file có sẵn để kiểm thử các API của module media.

Ngoài ra, cần tạo một file `tests/conftest.py` để định nghĩa các `fixture` dùng chung (ví dụ: `TestClient`, session database cho test, user mẫu, ...).

## 3. Thuật toán/Logic (Từng bước)

Kiến trúc kiểm thử sẽ dựa trên `pytest` và các `fixture` để tạo môi trường và dữ liệu test một cách cô lập và có thể tái sử dụng.

### 3.1. Module `auth` (File: `tests/test_auth.py`)

**Mục tiêu:** Kiểm tra các luồng đăng ký, đăng nhập, xác thực token, và đặt lại mật khẩu.

- **Test Case 1: Đăng ký (`/auth/register`)**
    - **Thành công:** Gửi request với email và mật khẩu hợp lệ. Mong đợi `201 CREATED`.
    - **Thất bại (Email trùng lặp):** Đăng ký 2 lần với cùng một email. Mong đợi `400 Bad Request` ở lần thứ hai.
    - **Thất bại (Mật khẩu không hợp lệ):** Gửi request với mật khẩu quá ngắn. Mong đợi `422 Unprocessable Entity`.

- **Test Case 2: Đăng nhập (`/auth/login`)**
    - **Thành công:** Dùng tài khoản đã đăng ký và kích hoạt. Mong đợi `200 OK` và nhận được `access_token`.
    - **Thất bại (Sai mật khẩu):** Mong đợi `401 Unauthorized`.
    - **Thất bại (Tài khoản không tồn tại):** Mong đợi `401 Unauthorized`.
    - **Thất bại (Tài khoản chưa kích hoạt):** Tạo user nhưng không xác minh email. Mong đợi `403 Forbidden`.

- **Test Case 3: Lấy thông tin người dùng (`/auth/me`)**
    - **Thành công:** Gửi request với `Authorization: Bearer <token>` hợp lệ. Mong đợi `200 OK` và thông tin user.
    - **Thất bại (Không có token):** Mong đợi `401 Unauthorized`.

- **Test Case 4: Xác minh Email (`/auth/verify-email`)**
    - **Thành công:** Dùng một verification token hợp lệ được tạo khi đăng ký. Mong đợi `200 OK` và user được active.
    - **Thất bại (Token không hợp lệ):** Mong đợi `400 Bad Request`.

### 3.2. Module `customers` (File: `tests/test_customers.py`)

**Mục tiêu:** Kiểm tra các thao tác CRUD và logic nghiệp vụ liên quan đến khách hàng.

- **Test Case 1: Tạo khách hàng vãng lai (`/customers/walk-in`)**
    - **Thành công:** Gửi request với tên và SĐT hợp lệ. Mong đợi `200 OK`.
    - **Thất bại (SĐT trùng lặp):** Tạo 2 khách hàng với cùng SĐT. Mong đợi `409 Conflict` ở lần thứ hai.

- **Test Case 2: Lấy thông tin khách hàng (`/customers/{customer_id}`)**
    - **Thành công:** Dùng ID của khách hàng đã tạo. Mong đợi `200 OK`.
    - **Thất bại (ID không tồn tại):** Mong đợi `404 Not Found`.

- **Test Case 3: Cập nhật khách hàng (`/customers/{customer_id}`)**
    - **Thành công:** User đã đăng nhập tự cập nhật hồ sơ của mình. Mong đợi `200 OK`.
    - **Thất bại (Không có quyền):** User A cố gắng cập nhật hồ sơ của User B. Mong đợi `403 Forbidden`.

- **Test Case 4: Tìm kiếm khách hàng (`/customers`)**
    - **Thành công:** Tìm kiếm với tên hoặc SĐT của khách hàng đã tạo. Mong đợi danh sách trả về có chứa khách hàng đó.
    - **Thành công (Pagination):** Kiểm tra các tham số `page` và `per_page` hoạt động đúng.

### 3.3. Module `media` (File: `tests/test_media.py`)

**Mục tiêu:** Kiểm tra các luồng tải lên, truy vấn và xóa media.

- **Test Case 1: Tải ảnh đại diện cho khách hàng (`/media/customers/{customer_id}/avatar`)**
    - **Thành công:** User đã đăng nhập tải lên avatar cho khách hàng tồn tại. Mong đợi `200 OK`.
    - **Thất bại (File không hợp lệ):** Tải lên file text thay vì file ảnh. Mong đợi `400 Bad Request`.
    - **Thất bại (File quá lớn):** Tải lên file ảnh có kích thước vượt ngưỡng cho phép. Mong đợi `413 Payload Too Large`.
    - **Thất bại (Khách hàng không tồn tại):** Tải avatar cho `customer_id` không có trong DB. Mong đợi `404 Not Found`.

- **Test Case 2: Lấy danh sách ảnh của khách hàng (`/media/customers/{customer_id}`)**
    - **Thành công:** Gọi API sau khi đã tải lên avatar. Mong đợi danh sách trả về có chứa thông tin ảnh.
    - **Thành công (Rỗng):** Gọi API cho khách hàng chưa có ảnh. Mong đợi danh sách rỗng.

- **Test Case 3: Xóa ảnh (`/media/{media_id}`)**
    - **Thành công:** User đã đăng nhập xóa ảnh đã tải lên. Mong đợi `200 OK`.
    - **Thất bại (Ảnh không tồn tại):** Xóa một `media_id` không có trong DB. Mong đợi `404 Not Found`.
